<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
</head>
<style>
    * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    background-color: black;
    color: white;
}

nav {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: white;
    margin-bottom: 20px;
}

nav ul {
    list-style-type: none;
    display: flex;
    gap: 10px;
    text-decoration: none;
    padding: 20px;
}

nav ul li {
    display: flex;
    flex-direction: column;
    font-size: 20px;
}

nav ul li a {
    text-decoration: none;
    color: black;
}


button {
    border: 1px transparent solid;
    border-radius: 5px;
    font-size: 20px;
    background-color: red;
    color: white;
    padding: 15px 10px;
}
</style>
<body>
    <nav>
        <ul>
            <li><a href="{{ url_for('index') }}">Home</a></li>
            <li><a href="{{ url_for('login') }}">Login</a></li>
            <li><a href="{{ url_for('staff_login') }}">Vendor Login</a></li>
            <li><a href="{{ url_for('signup') }}">Signup</a></li>
            <li><a href="{{ url_for('product_creation') }}">Create a Product</a></li>
            <li><a href="{{ url_for('product_page') }}">Product Page</a></li>
            <li><a href="{{ url_for('accounts') }}">Accounts</a></li>
            <li><a href="{{ url_for('my_orders') }}">My Orders</a></li>
        </ul>
    </nav>
    <br>
    <div class="center">
        <div id="cartItems" class="column">
            <br>
            <h2 >Thank you for your purchase,
                <div id="displayName"></div>
            </h2><br>
            <i style="text-align: center;">Your order will be ready is </i>

            <br><br>
            <div class="content-align">
                <div class="details"> Order details </div>
                <hr><br>
                <div class="cart-row">
                    <span class="cart-item cart-header cart-column">ITEM</span>
                    <span class="cart-price cart-header cart-column" >PRICE PER ITEM</span>
                    <span class="cart-quantity cart-header cart-column">QUANTITY</span>
                    <span class="cart-header cart-column">REMOVE</span>
                </div>
                <div id="itemsincart" class="cart-items">

                </div>
                <br>
                <div class="cart-total">
                    <strong class="cart-total-title" >Total</strong>
                    <span class="cart-total-price" >$0.00</span>
                </div>
            </div>
            <br>
            <div class="returnHomeButton">
                <button id="purchase-btn" onclick="returnHome(),clearCart()">Purchase</button>
            </div>
        </div>

    </div>

    <br>
</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/get_user_id')
        .then(res => {
            if (!res.ok) {
                console.error("Failed to fetch user ID. Status:", res.status);
                throw new Error("Failed to fetch user ID.");
            }
            return res.json();
        })
        .then(data => {
            if (data.user_id) {
                userId = data.user_id;
                console.log("Logged-in user ID:", userId);
            } else {
                console.warn("User ID not found in session. Response:", data);
                alert("You must be logged in to make a purchase.");
            }
        })
        .catch(err => {
            console.error("Error fetching user ID:", err);
            alert("Something went wrong while checking your login status.");
        });

        const purchase_btn = document.getElementById("purchase-btn")
        let data_info = 0
    
        fetch('/api/cart')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Not authorized or unable to fetch cart data.');
                }
                return response.json();
            })
            .then(data => {
                const itemsContainer = document.getElementById('itemsincart');
                const totalElement = document.querySelector('.cart-total-price');
                let total = 0;
                data_info = data;
    
                data.cart.forEach(item => {
                    const itemRow = document.createElement('div');
                    itemRow.classList.add('cart-row');
    
                    const nameCol = document.createElement('span');
                    nameCol.classList.add('cart-item', 'cart-column');
                    nameCol.innerText = item.name;
    
                    const priceCol = document.createElement('span');
                    priceCol.classList.add('cart-price', 'cart-column');
                    priceCol.innerText = `$${item.price.toFixed(2)}`;
    
                    const quantityCol = document.createElement('span');
                    quantityCol.classList.add('cart-quantity', 'cart-column');
    
                    const minusBtn = document.createElement('button');
                    minusBtn.innerText = 'âˆ’';
                    minusBtn.onclick = () => updateQuantity(item, -1);
    
                    const qtyDisplay = document.createElement('span');
                    qtyDisplay.innerText = item.quantity;
                    qtyDisplay.classList.add('qty-display');
    
                    const plusBtn = document.createElement('button');
                    plusBtn.innerText = '+';
                    plusBtn.onclick = () => updateQuantity(item, 1);
    
                    quantityCol.appendChild(minusBtn);
                    quantityCol.appendChild(qtyDisplay);
                    quantityCol.appendChild(plusBtn);
    
                   
                const removeCol = document.createElement('span');
                removeCol.classList.add('cart-column');
                const removeBtn = document.createElement('button');
                removeBtn.innerText = 'Remove';
                removeBtn.onclick = () => removeItemFromCart(item.product_id);
                removeCol.appendChild(removeBtn);

                
                itemRow.appendChild(nameCol);
                itemRow.appendChild(priceCol);
                itemRow.appendChild(quantityCol);
                itemRow.appendChild(removeCol); 

                itemsContainer.appendChild(itemRow);

                total += item.price * item.quantity;
            });

            totalElement.innerText = `$${total.toFixed(2)}`;
        })
        .catch(error => {
            console.error('Error loading cart:', error);
        });
    
        purchase_btn.addEventListener("click", function () {
            const rows = document.querySelectorAll('.cart-row');
            const cartItems = [];
            let totalCost = 0;
    
            rows.forEach(row => {
                const name = row.querySelector('.cart-item')?.innerText;
                const priceText = row.querySelector('.cart-price')?.innerText;
                const quantityText = row.querySelector('.qty-display')?.innerText;
    
                if (name && priceText && quantityText) {
                    const price = parseFloat(priceText.replace('$', '').trim());
                    const quantity = parseInt(quantityText.trim());
    
                    const matchingItem = data_info.cart.find(i => i.name === name);
                    if (!matchingItem) return;
    
                    cartItems.push({
                        product_title: name,
                        price: price,
                        quantity: quantity,
                        product_id: matchingItem.product_id
                    });
    
                    totalCost += price * quantity;
                }
            });
    
            const receiptPayload = {
                user_id: userId,
                cart: cartItems,
                total_price: totalCost.toFixed(2)
            };

            fetch('/api/sent_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(receiptPayload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Order failed: " + data.error);
                    return;
                }

                console.log("Order submitted to vendor:", data.message);

                // Only record receipt if order succeeded
                return fetch('/api/receipt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(receiptPayload)
                });
            })
            .then(res => {
                if (res && !res.ok) throw new Error("Failed to record receipt.");
                return res ? res.json() : null;
            })
            .then(data => {
                if (data) {
                    console.log("Receipt recorded:", data.message);
                }
                clearCart();
                returnHome();
            })
            .catch(error => {
                console.error("Transaction error:", error);
                alert("Something went wrong while processing your order.");
            });
        });
    });
    
    function updateQuantity(item, delta) {
    const rows = document.querySelectorAll('.cart-row');
    rows.forEach(row => {
        const name = row.querySelector('.cart-item')?.innerText;
        if (name === item.name) {
            const qtySpan = row.querySelector('.qty-display');
            let quantity = parseInt(qtySpan.innerText);
            quantity = Math.max(1, quantity + delta); // prevent 0

            // Update displayed quantity
            qtySpan.innerText = quantity;
            fetch('/api/update_cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        items: [{
            product_id: item.product_id,
            quantity: quantity
            }]
        })
    });

            // Recalculate total price
            const totalElement = document.querySelector('.cart-total-price');
            let newTotal = 0;

            document.querySelectorAll('.cart-row').forEach(row => {
                const qtyText = row.querySelector('.qty-display')?.innerText;
                const qty = qtyText ? parseInt(qtyText.trim()) : 0;
                const price = parseFloat(row.querySelector('.cart-price')?.innerText.replace('$', '') || "0");
                newTotal += qty * price;
            });

            totalElement.innerText = `$${newTotal.toFixed(2)}`;
        }
    });
}
    
function removeItemFromCart(productId) {
    fetch('/api/remove_from_cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId })
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to remove item');
        return response.json();
    })
    .then(data => {
        alert(data.message);
        location.reload(); 
    })
    .catch(error => console.error(error));
}
    
    function returnHome() {
        window.location.href = "/";
    }
    
    function clearCart() {
    fetch('/api/checkout', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Checkout failed');
        }
        return response.json();
    })
    .then(data => {
        alert(data.message);
    })
    .catch(error => {
        console.error(error);
        alert("There was an error during checkout.");
    });
}
    
function returnHome() {
    window.location.href = "/";
}
</script>
</html>